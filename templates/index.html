<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GapFinder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="header">
        <img src="{{ url_for('static', filename='images/logoGapFinder.png') }}" alt="GapFinder Logo" class="logo">
        <h1>GapFinder</h1>        
    </div>
    <div class="container">
        <div class="title-highlight">Research</div>
        <p>Explore new horizons with GapFinder: your innovative tool for extracting research gaps from PDF files, unveiling unexplored areas of scientific research, and pushing the frontier of knowledge.</p>
        {% if session.get('resultados') %}
        <div class="success-message">
            <p>‚úì Last upload processed successfully! You can download results or upload new files.</p>
        </div>
        {% endif %}
        <form action="/process" method="post" enctype="multipart/form-data">
            <div id="drop-zone" class="drop-zone" role="region"
                 aria-label="Drag and drop PDF files here or click to browse"
                 aria-describedby="drop-zone-help">
                <div class="drop-zone-icon">üìÅ</div>
                <p class="drop-zone-text">Drag PDF files here</p>
                <p class="drop-zone-text">or <span class="drop-zone-link" id="browse-link">click to browse</span></p>
                <p id="drop-zone-help" class="drop-zone-text" style="font-size: 12px; color: #999;">
                    Accepts multiple PDFs up to 20MB each, 50MB total
                </p>
            </div>
            <input type="file" name="pdf_files" id="pdf_files" multiple accept=".pdf" style="display: none;">
            <button type="button" id="mobile-upload-btn" class="button" style="display: none;">Upload PDF File</button>
            <button type="submit" class="button">Find Gaps</button>
        </form>

        <div id="file-preview" class="file-preview" style="display: none;">
            <h3>Selected Files:</h3>
            <ul id="file-list"></ul>
            <p class="file-info">
                <span id="file-count">0</span> file(s) |
                <span id="file-size">0</span> MB total
            </p>
        </div>

        <div id="loading" style="display:none;">
            <img src="{{ url_for('static', filename='images/loading.gif') }}" alt="Loading..." class="loading-gif" />
            <p>Please wait... This might take a while due to the AI processing.</p>
        </div>

        {% if request.args.get('error') %}
        <div class="error-message">
            <p>{{ request.args.get('error') }}</p>
        </div>
        {% endif %}        
    </div>
     
    <script>
        const fileInput = document.getElementById('pdf_files');
        const dropZone = document.getElementById('drop-zone');
        const mobileUploadBtn = document.getElementById('mobile-upload-btn');
        const browseLink = document.getElementById('browse-link');
        const filePreview = document.getElementById('file-preview');
        const fileList = document.getElementById('file-list');
        const fileCount = document.getElementById('file-count');
        const fileSize = document.getElementById('file-size');
        const form = document.querySelector('form');

        const MAX_FILE_SIZE = 20 * 1024 * 1024;
        const MAX_TOTAL_SIZE = 50 * 1024 * 1024;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
            dropZone.style.display = 'none';
            mobileUploadBtn.style.display = 'inline-block';
        }

        mobileUploadBtn.addEventListener('click', function() {
            fileInput.click();
        });

        function handleFileSelection(e) {
            const files = Array.from(e.target.files);

            if (files.length === 0) {
                filePreview.style.display = 'none';
                return;
            }

            fileList.innerHTML = '';
            let totalSize = 0;

            files.forEach(file => {
                const li = document.createElement('li');
                const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                li.className = 'file-item';

                if (!file.name.endsWith('.pdf')) {
                    li.className += ' file-item-invalid';
                    li.innerHTML = `<span class="file-name">${file.name}</span>
                                   <span class="file-warning">(not a PDF)</span>`;
                } else if (file.size > MAX_FILE_SIZE) {
                    li.className += ' file-item-warning';
                    li.innerHTML = `<span class="file-name">${file.name}</span>
                                   <span class="file-size">${sizeInMB} MB</span>
                                   <span class="file-warning">(exceeds 20MB)</span>`;
                } else {
                    li.innerHTML = `<span class="file-name">${file.name}</span>
                                   <span class="file-size">${sizeInMB} MB</span>`;
                }

                fileList.appendChild(li);
                totalSize += file.size;
            });

            fileCount.textContent = files.length;
            fileSize.textContent = (totalSize / 1024 / 1024).toFixed(2);

            if (totalSize > MAX_TOTAL_SIZE) {
                fileSize.className = 'size-warning';
            } else {
                fileSize.className = '';
            }

            filePreview.style.display = 'block';
        }

        fileInput.addEventListener('change', handleFileSelection);

        browseLink.addEventListener('click', function(e) {
            e.stopPropagation();
            fileInput.click();
        });

        dropZone.addEventListener('click', function(e) {
            if (e.target !== browseLink && (e.target === dropZone || e.target.closest('.drop-zone-text'))) {
                fileInput.click();
            }
        });

        if (!isMobile) {
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-active');
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-active');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-active');

                const dt = new DataTransfer();
                Array.from(e.dataTransfer.files).forEach(file => dt.items.add(file));
                fileInput.files = dt.files;

                handleFileSelection({ target: { files: dt.files } });
            });
        }

        form.onsubmit = function() {
            document.getElementById('loading').style.display = 'block';
        };
    </script>
</body>
</html>
